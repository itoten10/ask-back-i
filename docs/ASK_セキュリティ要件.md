# ASK（探究学習支援アプリ）セキュリティ要件書

## 1. 概要

### 1.1 本ドキュメントの目的
本ドキュメントは、学校向け探究学習支援アプリ「ASK」のセキュリティ要件を整理し、
理想的なセキュリティ対策とその費用感をまとめたものです。

学校で使用するアプリとして、生徒・教師の個人情報を適切に保護することが求められますが、
同時に限られた予算内での実現可能性も重要な観点となります。

### 1.2 対象システム
- **フロントエンド**: Next.js（Azure App Service）
- **バックエンド**: FastAPI（Azure App Service）
- **データベース**: Azure Database for MySQL
- **認証**: Google OAuth + TOTP（2要素認証）

### 1.3 取り扱うデータの分類

| データ分類 | 具体例 | 保護レベル |
|-----------|--------|-----------|
| 個人情報（機密） | 氏名、生年月日、メールアドレス | 最高 |
| 認証情報 | パスワードハッシュ、TOTPシークレット | 最高 |
| 学習データ | 探究活動記録、投稿内容 | 高 |
| 評価データ | 非認知能力スコア、教師コメント | 高 |
| システム情報 | ログイン履歴、セッション情報 | 中 |

---

## 2. 現在のセキュリティ実装状況

### 2.1 実装済みの対策

| 対策 | 実装状況 | 詳細 |
|------|---------|------|
| 認証方式 | ✅ 実装済み | Google OAuth + ローカル認証 |
| 2要素認証 | ✅ 実装済み | TOTP（Google Authenticator等） |
| パスワードハッシュ | ✅ 実装済み | Argon2（NIST推奨） |
| JWT トークン管理 | ✅ 実装済み | アクセス/リフレッシュトークン分離 |
| HttpOnly Cookie | ✅ 実装済み | リフレッシュトークン保護 |
| CORS設定 | ✅ 実装済み | オリジンホワイトリスト |
| SSL/TLS | ✅ 実装済み | Azure MySQL接続時必須 |
| ログイン監査ログ | ✅ 実装済み | 成功/失敗、IP、User-Agent記録 |
| 入力検証 | ✅ 実装済み | Pydanticスキーマ検証 |
| レート制限 | ⚠️ 部分実装 | メモリベース（2FA検証のみ） |
| ロールベースアクセス制御 | ✅ 実装済み | student/teacher/admin |

### 2.2 未実装・改善が必要な対策

| 対策 | 現状 | リスク | 実装難易度 |
|------|------|--------|-----------|
| WAF（Web Application Firewall） | 未実装 | SQLi、XSS等の攻撃に脆弱 | 中（Azure設定のみ） |
| DDoS対策 | 未実装 | サービス停止リスク | 低（Azure設定のみ） |
| VNet統合 | 未実装 | ネットワーク分離なし | 高（構成変更大） |
| シークレット管理 | .envファイル | 漏洩リスク | 中（コード変更要） |
| TOTPシークレット暗号化 | 無効 | DB漏洩時に2FA無効化 | 低（設定変更のみ） |
| 分散レート制限 | 未実装 | スケールアウト時に無効 | 中（Redis導入要） |
| 監査ログDB分離 | 未実装 | 改ざんリスク | 中（DB設計変更） |
| バックアップ暗号化 | Azure標準 | カスタム暗号化なし | 低（Azure設定のみ） |

### 2.3 脅威と対策のマッピング

| 脅威シナリオ | 現在の対策 | 追加で必要な対策 |
|------------|-----------|-----------------|
| **ブルートフォース攻撃**（パスワード総当たり） | メモリベースレート制限(2FAのみ) | Redis分散レート制限、アカウントロック |
| **SQLインジェクション** | Pydantic入力検証 | WAF、パラメータ化クエリの徹底 |
| **XSS（クロスサイトスクリプティング）** | React自動エスケープ | WAF、CSPヘッダー |
| **セッションハイジャック** | HttpOnly Cookie、短寿命トークン | Secure属性強化、IP検証 |
| **データベース漏洩** | TLS接続、基本暗号化 | カラム暗号化、Key Vault |
| **内部不正** | RBAC、監査ログ | ログDB分離、アラート |
| **DDoS攻撃** | なし | Azure Front Door、DDoS Protection |

---

## 3. 理想的なセキュリティアーキテクチャ

### 3.1 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           インターネット層                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │              Azure Front Door Premium                           │   │
│  │         WAF + DDoS Protection + TLS終端 + CDN                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                    │                              │
                    │ HTTPS                        │ HTTPS + MFA
                    │ (生徒・教師)                  │ (管理者)
                    ▼                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        Azure VNet - Private                             │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                      App Service Plan                            │  │
│  │  ┌─────────────────┐              ┌─────────────────┐           │  │
│  │  │  Frontend App   │              │   Admin App     │           │  │
│  │  │    Next.js      │              │  Azure AD + MFA │           │  │
│  │  └────────┬────────┘              └────────┬────────┘           │  │
│  │           │ VNet統合                        │ VNet統合           │  │
│  │           └──────────────┬─────────────────┘                    │  │
│  │                          ▼                                       │  │
│  │              ┌─────────────────────┐                            │  │
│  │              │    Backend API      │                            │  │
│  │              │      FastAPI        │                            │  │
│  │              └──────────┬──────────┘                            │  │
│  └──────────────────────────┼───────────────────────────────────────┘  │
│                             │ Private Endpoint                         │
│  ┌──────────────────────────┼───────────────────────────────────────┐  │
│  │           MySQL Flexible Server                                  │  │
│  │  ┌────────────┐  ┌────────────────┐  ┌────────────────┐         │  │
│  │  │ メインDB   │  │  個人情報DB    │  │  監査ログDB   │         │  │
│  │  │            │  │  TDE暗号化     │  │  Append-Only  │         │  │
│  │  └────────────┘  └────────────────┘  └────────────────┘         │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐           │
│  │   Key Vault    │  │  Blob Storage  │  │    Redis       │           │
│  │ シークレット管理 │  │ 暗号化バックアップ│  │  レート制限    │           │
│  │ Managed ID     │  │                │  │  セッション    │           │
│  └────────────────┘  └────────────────┘  └────────────────┘           │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 セキュリティ層の説明

| 層 | 目的 | 対策 |
|----|------|------|
| エッジ | 境界防御 | WAF、DDoS、TLS終端、地理的制限 |
| ネットワーク | 分離・制御 | VNet、NSG、Private Endpoint |
| アプリケーション | 認証・認可 | OAuth、2FA、RBAC、入力検証 |
| データ | 保護・暗号化 | TDE、カラム暗号化、マスキング |
| 運用 | 監視・監査 | ログ、アラート、バックアップ |

---

## 4. セキュリティ対策詳細と費用

### 4.1 費用算出の考え方

Azure の費用は以下の要素で決まります：

1. **SKU/プラン**: サービスの性能・機能レベル
2. **リージョン**: 東日本 vs 米国東部など
3. **使用量**: 時間、リクエスト数、データ量
4. **予約**: 1年/3年コミットで最大72%割引

**費用確認方法**:
- [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/)
- Azure Portal の「コスト分析」
- `az consumption` CLI コマンド

### 4.2 対策別費用一覧

#### 4.2.1 必須対策（最低限実装すべき）

| 対策 | 月額費用目安 | 実装難易度 | 効果 |
|------|-------------|-----------|------|
| **Azure Key Vault** | ¥500〜1,000 | 低 | シークレット漏洩防止 |
| シークレット管理 | Standard: $0.03/10k操作 | | |
| | | | |
| **TOTPシークレット暗号化** | ¥0（実装のみ） | 低 | 2FA無効化防止 |
| 既存のEncryption設定を有効化 | 設定変更のみ | | |
| | | | |
| **Redis Cache（Basic）** | ¥2,000〜3,000 | 中 | レート制限の分散対応 |
| 分散レート制限・セッション管理 | C0: 約$16/月 | | |
| | | | |
| **セキュリティヘッダー** | ¥0（実装のみ） | 低 | XSS、クリックジャッキング防止 |
| CSP, X-Frame-Options等 | コード追加のみ | | |

**小計（必須）**: 約¥2,500〜4,000/月

#### 4.2.2 推奨対策（リスク低減に効果的）

| 対策 | 月額費用目安 | 実装難易度 | 効果 |
|------|-------------|-----------|------|
| **Azure Front Door + WAF** | ¥15,000〜25,000 | 中 | SQLi、XSS、DDoS対策 |
| Standard: 約$35/月 + ルール | | | |
| Premium: 約$330/月 | | | |
| | | | |
| **VNet統合** | ¥3,000〜5,000 | 高 | ネットワーク分離 |
| App Service VNet Integration | 追加料金なし（Premium以上） | | |
| Private Endpoint | 約$7.3/エンドポイント/月 | | |
| | | | |
| **監査ログDB分離** | ¥3,000〜5,000 | 中 | 監査証跡の改ざん防止 |
| 別DBインスタンスまたはテーブル | Burstable B1ms: 約$13/月 | | |
| | | | |
| **Log Analytics** | ¥2,000〜5,000 | 低 | 監視・アラート |
| Azure Monitor統合 | $2.30/GB取り込み | | |

**小計（推奨）**: 約¥23,000〜40,000/月

#### 4.2.3 理想対策（高セキュリティ環境）

| 対策 | 月額費用目安 | 実装難易度 | 効果 |
|------|-------------|-----------|------|
| **Azure Front Door Premium** | ¥40,000〜50,000 | 中 | 高度なWAF、Private Link |
| Premium + マネージドルール | 約$330/月 + トラフィック | | |
| | | | |
| **Microsoft Defender for Cloud** | ¥5,000〜15,000 | 低 | 脆弱性スキャン、脅威検出 |
| Standard: 約$15/サーバー/月 | | | |
| | | | |
| **Azure AD B2C** | ¥5,000〜10,000 | 高 | 高度なID管理 |
| 認証の外部化 | 50k MAU まで無料 | | |
| | | | |
| **Blob Storage（GRS）** | ¥2,000〜5,000 | 低 | 災害復旧用バックアップ |
| 地理冗長ストレージ | $0.04/GB + 操作 | | |

**小計（理想）**: 約¥52,000〜80,000/月

### 4.3 費用サマリー

| レベル | 月額費用 | 年額費用 | 対象 |
|--------|---------|---------|------|
| **必須** | ¥2,500〜4,000 | ¥30,000〜48,000 | 最低限のセキュリティ |
| **必須+推奨** | ¥25,500〜44,000 | ¥306,000〜528,000 | 一般的な学校向け |
| **フル実装** | ¥77,500〜124,000 | ¥930,000〜1,488,000 | 高セキュリティ要件 |

※ 上記は概算であり、実際の費用はAzure Pricing Calculatorで確認してください。
※ 予約インスタンス（1年/3年）で20〜70%の割引が適用可能です。

---

## 5. 実装優先度とロードマップ

### 5.1 Phase 1: 即座に対応（1〜2週間）

**費用**: ほぼ¥0（実装工数のみ）

1. **セキュリティヘッダーの追加**
   ```python
   # FastAPI middleware
   @app.middleware("http")
   async def add_security_headers(request, call_next):
       response = await call_next(request)
       response.headers["X-Content-Type-Options"] = "nosniff"
       response.headers["X-Frame-Options"] = "DENY"
       response.headers["X-XSS-Protection"] = "1; mode=block"
       response.headers["Strict-Transport-Security"] = "max-age=31536000"
       return response
   ```

2. **TOTPシークレット暗号化の有効化**
   ```
   ENCRYPT_TOTP_SECRET=true
   ENCRYPTION_KEY=<32バイトのランダム文字列>
   ```

3. **CORSヘッダーの厳格化**
   ```python
   allow_headers=["Authorization", "Content-Type"]  # 必要最小限に
   ```

4. **.envファイルの.gitignore確認**
   ```gitignore
   .env
   .env.local
   .env.production
   ```

### 5.2 Phase 2: 短期対応（1〜2ヶ月）

**費用**: 約¥2,500〜4,000/月

1. **Azure Key Vault導入**
   - シークレット（DB_PASSWORD, JWT_SECRET等）をKey Vaultに移行
   - Managed Identityで認証

2. **Redis Cache導入**
   - レート制限の分散対応
   - セッション管理の強化

3. **ログイン監査の強化**
   - 異常検知ルールの追加
   - 管理者への通知機能

### 5.3 Phase 3: 中期対応（3〜6ヶ月）

**費用**: 約¥25,000〜40,000/月追加

1. **Azure Front Door + WAF**
   - WAFルールセット（OWASP）の適用
   - DDoS Protection Standard

2. **VNet統合**
   - App ServiceのVNet統合
   - DBのPrivate Endpoint化

3. **Log Analytics統合**
   - 監視ダッシュボード構築
   - アラートルール設定

### 5.4 Phase 4: 長期対応（6ヶ月〜）

**費用**: 要件に応じて

1. **Microsoft Defender for Cloud**
2. **監査ログDB分離**
3. **地理冗長バックアップ**
4. **ペネトレーションテスト実施**

---

## 6. インシデント対応計画（概要）

### 6.1 インシデント発生時のフロー

```
発見・検知 → 初期対応 → 影響範囲特定 → 封じ込め → 復旧 → 報告・再発防止
```

| ステップ | 対応内容 | 担当 | 目標時間 |
|---------|---------|------|---------|
| 発見・検知 | 監視アラート、ユーザー報告 | 監視担当/全員 | 即時 |
| 初期対応 | 状況確認、エスカレーション | 開発チーム | 30分以内 |
| 影響範囲特定 | ログ分析、データ確認 | 開発チーム | 2時間以内 |
| 封じ込め | アクセス遮断、パスワードリセット | 開発チーム | 4時間以内 |
| 復旧 | サービス再開、監視強化 | 開発チーム | 24時間以内 |
| 報告・再発防止 | 報告書作成、対策実施 | 管理者 | 72時間以内 |

### 6.2 個人情報漏洩時の対応（法的義務）

1. **個人情報保護委員会への報告** - 速やかに（概ね3〜5日以内）
2. **本人への通知** - 速やかに
3. **原因究明と再発防止策の策定**
4. **記録の保存**（5年間）

---

## 7. コンプライアンス考慮事項

### 7.1 個人情報保護法対応

| 要件 | 対応状況 | 備考 |
|------|---------|------|
| 利用目的の特定・公表 | 要確認 | プライバシーポリシー |
| 安全管理措置 | 部分実装 | 暗号化、アクセス制御 |
| 第三者提供の制限 | 要確認 | Google OAuth連携 |
| 開示請求への対応 | 未実装 | データエクスポート機能 |
| 漏洩時の報告義務 | 未整備 | インシデント対応手順 |

### 7.2 学校特有の要件

| 要件 | 対応方針 |
|------|---------|
| 未成年者のデータ保護 | 保護者同意の取得フロー |
| 教育委員会のセキュリティ基準 | 個別確認が必要 |
| 年度末のデータ削除 | バッチ処理で論理削除→物理削除 |
| 転校・卒業時のデータ移行 | エクスポート機能 |

---

## 8. 費用の詳細な算出方法

### 8.1 Azure Pricing Calculatorの使い方

1. https://azure.microsoft.com/pricing/calculator/ にアクセス
2. 必要なサービスを追加（例: App Service, MySQL, Redis）
3. リージョン、SKU、使用量を設定
4. 月額/年額の見積もりを確認
5. 「エクスポート」でExcel出力可能

### 8.2 主要サービスの費用構造

#### App Service
```
費用 = プラン料金（固定）+ スロット追加料金
例: Premium v3 P1V3 = 約¥15,000/月（東日本）
```

#### Azure Database for MySQL
```
費用 = コンピューティング + ストレージ + バックアップ + ネットワーク
例: Burstable B1ms + 20GB = 約¥2,500/月
```

#### Azure Front Door
```
費用 = 基本料金 + データ転送 + リクエスト数 + WAFルール
例: Standard + 10GB転送 + 100万リクエスト = 約¥5,000/月
```

#### Redis Cache
```
費用 = プラン料金（固定）
例: Basic C0 = 約¥2,000/月
```

### 8.3 コスト最適化のヒント

1. **予約インスタンス**: 1年で約20%、3年で約40%割引
2. **開発/ステージング環境**: Basic/Free tierを活用
3. **オートスケール**: 使用量に応じた自動調整
4. **スポットインスタンス**: バッチ処理に活用（最大90%割引）
5. **Azure Hybrid Benefit**: 既存ライセンスの活用

---

## 9. まとめ

### 9.1 推奨アクションプラン

| 優先度 | 対策 | 費用 | 効果 |
|--------|------|------|------|
| 🔴 最優先 | セキュリティヘッダー追加 | ¥0 | 即効性あり |
| 🔴 最優先 | TOTP暗号化有効化 | ¥0 | 2FA保護強化 |
| 🟠 高 | Key Vault導入 | ¥1,000/月 | シークレット保護 |
| 🟠 高 | Redis導入 | ¥2,500/月 | レート制限強化 |
| 🟡 中 | Front Door + WAF | ¥15,000/月 | 境界防御 |
| 🟡 中 | VNet統合 | ¥5,000/月 | ネットワーク分離 |
| 🟢 低 | Defender for Cloud | ¥10,000/月 | 脅威検出 |

### 9.2 学校向けの現実的な提案

**小規模校（生徒数〜300人）**
- Phase 1 + Phase 2 を推奨
- 月額: 約¥5,000〜10,000
- 年額: 約¥60,000〜120,000

**中規模校（生徒数300〜1000人）**
- Phase 1 + Phase 2 + Phase 3（一部）を推奨
- 月額: 約¥20,000〜40,000
- 年額: 約¥240,000〜480,000

**大規模校・教育委員会一括導入**
- フル実装を検討
- 月額: 約¥80,000〜150,000
- 年額: 約¥960,000〜1,800,000
- ボリュームディスカウント適用可能

### 9.3 セキュリティは「投資」

> 「セキュリティ対策の費用は高い」と感じるかもしれませんが、
> **情報漏洩が発生した場合のコスト**と比較することが重要です。
>
> - 漏洩対応費用: 数百万〜数千万円
> - 信頼失墜による影響: 計り知れない
> - 法的責任: 罰則・損害賠償
>
> 適切なセキュリティ投資は、学校と生徒を守るための「保険」です。

---

## 付録

### A. 用語集

| 用語 | 説明 |
|------|------|
| WAF | Web Application Firewall - Webアプリへの攻撃を検知・ブロック |
| DDoS | Distributed Denial of Service - 大量リクエストによるサービス妨害攻撃 |
| VNet | Virtual Network - Azure上の仮想ネットワーク |
| TDE | Transparent Data Encryption - データベースの透過的暗号化 |
| TOTP | Time-based One-Time Password - 時間ベースのワンタイムパスワード |
| RBAC | Role-Based Access Control - ロールベースのアクセス制御 |
| NSG | Network Security Group - ネットワークトラフィックのフィルタリング |

### B. 参考リンク

- [Azure セキュリティベストプラクティス](https://docs.microsoft.com/azure/security/fundamentals/best-practices-and-patterns)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [個人情報保護法ガイドライン](https://www.ppc.go.jp/personalinfo/legal/)
- [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/)

---

**文書管理情報**
- 作成日: 2025年12月17日
- 作成者: Claude Code
- バージョン: 1.1
- 次回レビュー予定: 導入決定時

**更新履歴**
| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2025-12-17 | 初版作成 |
| 1.1 | 2025-12-17 | 脅威モデリング追加、インシデント対応計画追加、実装難易度追加 |
